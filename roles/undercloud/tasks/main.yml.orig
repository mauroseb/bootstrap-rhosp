---
# Setup undercloud VM
- name: "Setup undercloud VM"
  tags:
    - undercloud-setup
  block:
  - name: Ensure undercloud vm is on
    virt:
      name: "{{ undercloud_name }}"
      state: running
    delegate_to: localhost

  - name: "Wait for {{ undercloud_name }} to become available"
    wait_for:
      host: 192.168.122.253
      port: 22
      search_regex: OpenSSH
      timeout: 120
    register: wf_ucready
    delegate_to: localhost

  - name: "Create group for user {{ username }}"
    group:
      name: "{{ username }}"
      gid: 9999
      state: present

  - name: "Create user {{ username }}"
    user:
      name: "{{ username }}"
      comment: "RHOSP deployment user"
      createhome: yes
      group: "{{ username }}"
      groups: wheel
      append: yes
      shell: /bin/bash
      uid: 9999
      update_password: on_create
      state: present
      password: "$6$A6Fr7CCy5sJg508S$jr93cfx5vAhkjSWcWckwvoD5IdNIEx0Ja1ab5kCaSl/4SmADRWHKa/XQJ2Ku0HbsyhXSiQM0.8PgbKKnCbIj9/"

  - name: "Create sudo entry for  {{ username }}"
    lineinfile:
      path: /etc/sudoers
      state: present
      regexp: '{{ username }} ALL='
      line: '{{ username }} ALL=(ALL) NOPASSWD: ALL'
      validate: /usr/sbin/visudo -cf %s

  - name: Register undercloud server to CDN
    redhat_subscription:
      username: "{{ cdnuser }}"
      password: "{{ cdnpass }}"
      pool_ids: "{{ poolid }}"
      state: present
    when:
      - not satellite|bool

  - name: "RHOSP {{ rhosp_version }} version specific tasks"
    include_tasks: "osp{{ rhosp_version }}.yml"

  - name: Update OS
    yum:
      name: '*'
      state: latest

  - name: "Create undercloud.conf in {{ username }} home"
    template:
      src: undercloud.conf.j2
      dest: "/home/{{ username }}/undercloud.conf"
      owner: "{{ username }}"
      group: "{{ username }}"
      setype: user_home_t
      mode: u=rw,g=r,o=r

  - name: "Create nodes.json in {{ username }} home"
    copy:
      src: nodes.json
      dest: "/home/{{ username }}/nodes.json"
      owner: "{{ username }}"
      group: "{{ username }}"
      setype: user_home_t
      mode: u=rw,g=r,o=r

  - name: "create conatiner-image-prepare.yaml"
    become_user: stack
    command: |
      openstack tripleo container image prepare default   --local-push-destination   --output-env-file containers-prepare-parameter.yaml


  - name: "Add credentials to  conatiner-image-prepare.yaml"
    lineinfile:
      My creds

  - name: "Create VM snapshot pre undercloud install"
    command: |
      /usr/bin/virsh snapshot-create-as  {{ undercloud_name }} {{ undercloud_name }}-pre-install
    delegate_to: localhost

  - name: "Source stackrc"
    become_user: stack
    command:

  - name: "Upload images "
    become_user: stack
    command: |
      openstack overcloud image upload --image-path /home/{{ username }}/images/

  - name: "Import nodes"
    become_user: stack
    command: |
      openstack undercloud install

  - name: "Set DNS for provisioning network"
    become_user: stack
    command: |
      openstack subnet set --dns-nameserver 192.168.122.1 --dns-nameserver 192.168.2.254 ctlplane-subnet

  - name: "Disable iscsi and iscsi.sock service which is enabled by libguestfs-ttols or see the deployment fail"
    become_user: stack
    service:
      name: iscsi
      state: disabled

  - name: "Clone templates repo"
    become_user: stack
    git:
      url: github.com/mauroseb/tht-rhosp16
      dest: /home/{{ username }}/templates

  - name: "Copy deployment script to home"
    become_user: stack
    copy:
      src:  /home/{{ username }}/templates/deploy.sh
      dest: /home/{{ username }}/
      remote_src: yes

  - name: "Import nodes"
    become_user: stack
    command:|
      openstack overcloud node import /home/{{ username }}/nodes.json

  - name: "Instrospect all manageable nodes"
    become_user: stack
    command:|
      openstack overcloud node introspect --all-manageable --provide

...
